name: Build Android APK (TWA)

on:
  workflow_dispatch:
    inputs:
      manifest_url:
        description: 'Cloudflare Tunnel Manifest URL (e.g. https://xyz.trycloudflare.com/manifest.webmanifest)'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Verify Manifest URL
        run: |
          echo "Checking if manifest is reachable: ${{ github.event.inputs.manifest_url }}"
          curl -f -I "${{ github.event.inputs.manifest_url }}" || (echo "ERROR: Manifest URL is not reachable from GitHub. Ensure your Cloudflare Tunnel is running and accessible." && exit 1)

      - name: Install Bubblewrap
        run: sudo npm install -g @bubblewrap/cli

      - name: Configure Bubblewrap
        run: |
          mkdir -p ~/.bubblewrap
          echo "{\"jdkPath\":\"$JAVA_HOME\",\"androidSdkPath\":\"$ANDROID_SDK_ROOT\"}" > ~/.bubblewrap/config.json
          cat ~/.bubblewrap/config.json

      - name: Initialize TWA Project
        run: |
          mkdir android-app
          cd android-app
          # Bubblewrap init can be tricky with interactive prompts. 
          # We use yes to accept all defaults and suppress standard output except errors.
          yes "" | bubblewrap init --manifest="${{ github.event.inputs.manifest_url }}" --confirmResNames

      - name: Build APK
        run: |
          cd android-app
          # We need to provide dummy answers for signing key generation
          # 1. Key store password
          # 2. Key password
          # 3. Name, unit, org, etc.
          printf "password\npassword\nJohn Doe\nIT\nKrishiSahAI\nBaramati\nMaharashtra\nIN\nyes\n" | bubblewrap build
          
      - name: Find APK
        run: |
          echo "APK_PATH=$(find android-app -name "*signed.apk" | head -n 1)" >> $GITHUB_ENV

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: KrishiSahAI-Android-APK
          path: ${{ env.APK_PATH }}
